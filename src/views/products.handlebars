<h1>Productos</h1>

<form method="get" action="/products" style="margin-bottom:10px;">
  <input type="text" name="query" placeholder="category:Calzado o status:true" value="{{query}}" />
  <select name="sort">
    <option value="asc" {{#if (eq sort "asc")}}selected{{/if}}>Precio ↑</option>
  </select>
  <input type="number" name="limit" min="1" value="{{limit}}" placeholder="limit" />
  <button type="submit">Filtrar</button>
</form>

<ul id="productsList">
  {{#each products}}
    <li data-id="{{this._id}}">
      <div>
        <strong>{{this.title}}</strong> — ${{this.price}} — {{this.category}}
        <div style="font-size:0.9em;color:#666">{{this.description}}</div>
      </div>
      <div style="display:flex; gap:10px;">
        <a href="/products/{{this._id}}">Ver detalle</a>
        <button class="addToCartBtn" data-pid="{{this._id}}">Agregar al carrito</button>
      </div>
    </li>
  {{/each}}
</ul>

<div style="margin-top:12px;">
  {{#if hasPrevPage}}<a href="{{prevLink}}">« Anterior</a>{{/if}}
  <span style="margin:0 10px;">Página {{page}} / {{totalPages}}</span>
  {{#if hasNextPage}}<a href="{{nextLink}}">Siguiente »</a>{{/if}}
</div>

<script>
  // Pequeño helper de comparación para el select de sort si no lo registraste en server
  (function polyfillEqHelper(){
    try {
      // Si no existe Handlebars.helpers.eq, lo registramos (sólo afecta al cliente si usa hbs runtime)
      if (typeof Handlebars !== "undefined" && !Handlebars.helpers.eq) {
        Handlebars.registerHelper("eq", function (a, b) { return a === b; });
      }
    } catch(_) {}
  })();

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".addToCartBtn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const pid = btn.dataset.pid;
        const cid = prompt("Ingrese su Cart ID (cid):");
        if (!cid) return;
        const res = await fetch(`/api/carts/${cid}/product/${pid}`, { method: "POST" });
        const data = await res.json();
        if (data.status === "success") alert("Agregado al carrito");
        else alert(data.error || "Error al agregar");
      });
    });
  });
</script>
